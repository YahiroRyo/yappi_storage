# システムアーキテクチャ

## 概要

Yappi Storageは、マイクロサービス的な構成を持つ個人用ストレージシステムです。フロントエンド、バックエンド、データベース、キャッシュ層が明確に分離されています。

## 全体アーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend       │    │   Database      │
│   (Next.js)     │◄──►│   (Golang)      │◄──►│   (PostgreSQL)  │
│   Port: 3000    │    │   Port: 8000    │    │   with pgvector │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │     Redis       │
                       │   (Cache)       │
                       │   Port: 6379    │
                       └─────────────────┘
```

## コンテナ構成

### 開発環境 (compose.yaml)
- **frontend**: Next.js開発サーバー (ポート3000)
- **backend**: Go Airホットリロード環境 (ポート8000, 9000)
- **postgres**: PostgreSQL with pgvector
- **redis**: キャッシュサーバー

### 本番環境 (production.yaml)
- 最適化されたビルドとランタイム設定
- ヘルスチェックとログ管理強化

## バックエンドアーキテクチャ

### ディレクトリ構造
```
backend/
├── domain/          # ドメインロジック
│   ├── file/       # ファイルエンティティ
│   ├── user/       # ユーザーエンティティ
│   └── vector/     # ベクトル検索
├── infrastructure/ # インフラストラクチャ層
│   ├── database/   # DB接続とマイグレーション
│   ├── repository/ # データアクセス層
│   └── route/      # ルーティング設定
├── presentation/   # プレゼンテーション層
│   ├── api/        # REST API
│   ├── controller/ # HTTPコントローラー
│   ├── middleware/ # ミドルウェア
│   └── ws/         # WebSocket通信
├── service/        # ビジネスロジック
└── helper/         # ユーティリティ
```

### レイヤードアーキテクチャ
1. **Presentation Layer**: HTTP/WebSocketエンドポイント
2. **Service Layer**: ビジネスロジックの実装
3. **Domain Layer**: ドメインエンティティとロジック
4. **Infrastructure Layer**: 外部システムとの接続

## フロントエンドアーキテクチャ

### ディレクトリ構造
```
frontend/src/
├── app/            # Next.js App Router
├── components/     # 再利用可能コンポーネント
│   ├── ui/        # UIコンポーネント
│   └── fileControl/ # ファイル操作専用
├── api/           # API通信ロジック
└── .storybook/    # Storybook設定
```

### 主要機能
- **ファイル管理**: アップロード、ダウンロード、移動、削除
- **ディレクトリ操作**: 作成、名前変更、移動
- **検索機能**: ベクトル検索による高度な検索
- **ユーザー管理**: 認証、セッション管理

## データフロー

### ファイルアップロード
1. フロントエンド → WebSocket → チャンク転送
2. バックエンド → ファイルシステム保存
3. メタデータ → PostgreSQL保存
4. ベクトル → pgvector保存

### ファイル検索
1. 検索クエリ → ChatGPT API (ベクトル変換)
2. ベクトル検索 → pgvector
3. 結果 → Redis キャッシュ
4. フロントエンド表示

## セキュリティ

- **認証**: セッションベース + APIトークン
- **CORS**: 適切なCORS設定
- **ファイルアクセス**: ユーザー権限チェック
- **入力検証**: 各層での検証

## パフォーマンス

- **キャッシュ戦略**: Redis活用
- **ファイル配信**: 静的ファイル直接配信
- **チャンク処理**: 大ファイル対応
- **コネクションプール**: DB最適化

## 監視・ログ

- **アプリケーションログ**: 日付別ファイル出力
- **エラーハンドリング**: 構造化エラー管理
- **パフォーマンス**: メトリクス収集準備 